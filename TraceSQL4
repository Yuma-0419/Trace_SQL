--対象URL
　https://github.com/mustafaa7med/Hotel-Management-System-PLSQL/tree/main

--ファイル名
　README.md

--文字数
　約198行

--備考
　参考先のコードを分割して複数回掛けて解析予定

--コード
# Find Room Reservation

```sql
-- Creating a function to retrieve room_reservation details
CREATE OR REPLACE FUNCTION find_reservation(b_id number) RETURN varchar2 IS

v_room_id room_reservation.room_id%type;
v_guest_id room_reservation.guest_id%type;
v_booking_id room_reservation.booking_id%type;
v_booking_invoice room_reservation.booking_invoice%type;
reservation_details varchar2(150);

BEGIN
    SELECT room_id,
           guest_id,
           booking_id,
           booking_invoice
    INTO v_room_id,
         v_guest_id,
         v_booking_id,
         v_booking_invoice
    FROM room_reservation
    WHERE booking_id = b_id;
    reservation_details := 'Room ' || v_room_id || ' Is reserved for ' || v_guest_id || ' with a booking ID ' || v_booking_id || ' and a booking invoice of approx. ' || v_booking_invoice;
    RETURN reservation_details;
END;
　→引数として受け取ったb_idの値を条件として、「room_reservation」テーブルから該当するデータを取得して、
　 「Room [ルームID] Is reserved for [顧客ID] with a booking ID [予約ID] and a booking invoice of approx. [予約請求書]」
　 と表示するファンクション「find_reservation」を作成するSQL。
　　＊指定された予約IDに該当する部屋の予約情報を表示するSQL。

# Find Event

```sql
-- Creating a function to retrieve event details
CREATE OR REPLACE FUNCTION find_event(e_id number) RETURN varchar2 IS

v_event_id event.event_id%type;
v_event_name event.event_name%type;
event_details VARCHAR2(150);

BEGIN
    SELECT event_id,
           event_name
    INTO v_event_id,
         v_event_name
    FROM event
    WHERE event_id = e_id;
    event_details := 'Event id ' || v_event_id || ' is  ' || v_event_name;
    RETURN event_details;
END;
　→引数として受け取ったe_idの値を条件として、「event」テーブルから該当するデータを取得して、
　 「Event id [イベントID] is [イベント名]」と表示するファンクション「find_event」を作成するSQL。
　　＊指定されたイベントIDに該当するイベントの情報を表示するSQL。

# Find Event Reservation

```sql
-- Creating a function to retrieve event reservation details
CREATE OR REPLACE FUNCTION find_event_reservation(e_id number) RETURN varchar2 IS

v_event_id event_in_hotel.event_id%type;
v_guest_id event_in_hotel.guest_id%type;
v_reserv_id event_in_hotel.reserv_id%type;
v_start_date event_in_hotel.start_date%type;
v_end_date event_in_hotel.end_date%type;
v_event_invoice event_in_hotel.event_invoice%type;
event_reservation_details varchar2(250);

BEGIN
    SELECT event_id,
           guest_id,
           reserv_id,
           start_date,
           end_date,
           event_invoice
    INTO    v_event_id,
            v_guest_id,
            v_reserv_id,
            v_start_date,
            v_end_date,
            v_event_invoice
    FROM event_in_hotel
    WHERE event_id = e_id;
    event_reservation_details := 'Event  ' || v_event_id || ' which is booked by guest ID ' || v_guest_id || ' with a reservation id ' || v_reserv_id || ' has started on ' || v_start_date ||
                                              ' and an end date of ' || v_end_date || ' and its invoice is ' || v_event_invoice;
    RETURN event_reservation_details;
END;
　→引数として受け取ったe_idの値を条件として、「event_in_hotel」テーブルから該当するデータを取得して、
　 「Event [イベントID] which is booked by guest ID [顧客ID] with a reservation id [予約ID] has started on [開始日付] and an end date of [終了日付] and its invoice is [イベント請求書]」
　 と表示するファンクション「find_event_reservation」を作成するSQL。
　　＊指定されたイベントIDに該当するホテルのイベント情報を表示するSQL。

# Room Registry Trigger

```sql
-- Creating a trigger to track room's availability in case a room was reserved
CREATE OR REPLACE TRIGGER room_registry_trg
AFTER INSERT ON room_reservation
REFERENCING NEW AS New OLD AS Old
FOR EACH ROW

BEGIN
    INSERT INTO room_registry VALUES(:Old.room_id, :Old.hotel_id, sysdate, 'booked');
END;
　→「room_reservation」へのINSERT処理をトリガーとして、
　　更新前のデータを「Old」更新後のデータを「New」と定義づけた上で、
　　INSERTされた行数分「room_registry」テーブルに更新前ルームID、更新前ホテルID、「当日日付」、「予約済み」と登録するトリガー「room_registry_trg」を作成するSQL。
　　＊部屋が予約された際にその数だけ部屋の空き情報を更新するためのSQL。
　　　更新情報を登録する処理のはずですが「room_registry」への登録内容に「Old」の値が使われるようになっているため、SQLの方が間違っている可能性あり。
　　　　→誤：Old.room_id　→　正：New.room_id

# Cancel Room Registry Trigger

```sql
-- Creating a trigger to track room's availablility in case a room was cancelled

CREATE OR REPLACE TRIGGER cancel_room_registry_trg
AFTER DELETE ON room_reservation
REFERENCING NEW AS New OLD AS Old
FOR EACH ROW

BEGIN
    INSERT INTO room_registry VALUES(:Old.room_id, :Old.hotel_id, sysdate, 'available');
END;
　→「room_reservation」へのDELETE処理をトリガーとして、
　　更新前のデータを「Old」更新後のデータを「New」と定義づけた上で、
　　DELETEされた行数分「room_registry」テーブルに更新前ルームID、更新前ホテルID、「当日日付」、「利用可能」と登録するトリガー「cancel_room_registry_trg」を作成するSQL。
　　＊部屋の予約が解除された際にその数だけ部屋の空き情報を更新するためのSQL。

# Creating Object Package

```sql
-- Package Specs
CREATE OR REPLACE PACKAGE create_object IS
PROCEDURE add_hotel(h_id number,
                                      h_name varchar2,
                                      h_address varchar2,
                                      h_phone varchar2
                                      );
PROCEDURE add_room(r_id number,
                                     h_id number,
                                     r_price number,
                                     r_size varchar2,
                                     r_capacity number
                                     );
PROCEDURE add_guest(g_id number,
                                      g_name varchar2,
                                      g_phone varchar2,
                                      g_email varchar2
                                      );
PROCEDURE book_room(r_id number,
                                      g_id number,
                                      b_id number,
                                      b_invoice number
                                      );
PROCEDURE add_event(e_id number,
                                      e_name varchar2
                                      );
PROCEDURE cancel_room_reservation(r_id number,
                                                    g_id number,
                                                    b_id number
                                                    );
END;
　→関連する6つのプロシージャを1まとめにしたパッケージ「create_object」の仕様部を作成するSQL
　　＊ホテルに関する6つの機能を1つのパッケージにまとめるSQL。
　　　具体的な機能は下記の「Package Body」で実装。

-- Package Body
CREATE OR REPLACE PACKAGE BODY create_object IS
PROCEDURE add_hotel(h_id number,
                                      h_name varchar2,
                                      h_address varchar2,
                                      h_phone varchar2
                      ) IS

BEGIN
    INSERT INTO hotel VALUES(hotel_seq.nextval, h_name, h_address, h_phone);
END;

PROCEDURE add_room(r_id number,
                                     h_id number,
                                     r_price number,
                                     r_size varchar2,
                                     r_capacity number
                                     ) IS
unique_exception EXCEPTION;  
PRAGMA EXCEPTION_INIT(unique_exception, -00001);

BEGIN
    INSERT INTO room VALUES(room_seq.nextval, h_id, r_price, r_size, r_capacity);
    EXCEPTION
        WHEN unique_exception THEN
            dbms_output.put_line(' The room size has to be one of the following: small, medium, large');
END;

PROCEDURE add_guest(g_id number,
                                      g_name varchar2,
                                      g_phone varchar2,
                                      g_email varchar2
                                      ) IS
BEGIN
    INSERT INTO guest VALUES(guest_seq.nextval, g_name, g_phone, g_email);
END;

PROCEDURE book_room(r_id number,
                                      g_id number,
                                      b_id number,
                                      b_invoice number
                                      ) IS
foreign_exception EXCEPTION;                  
PRAGMA EXCEPTION_INIT(foreign_exception, -02291);       
                                                
BEGIN
    INSERT INTO room_reservation VALUES(r_id, g_id, b_id, b_invoice);
    EXCEPTION
        WHEN no_data_found THEN
                    dbms_output.put_line(g_id || ' Is not a registered guest, Kindly registed the guest before booking a room');
        WHEN foreign_exception THEN
         dbms_output.put_line(' There is a foreign key constraint, Kindly consider the values');
END;

PROCEDURE add_event(e_id number,
                                      e_name varchar2
                                      ) IS

BEGIN
    INSERT INTO event VALUES(event_seq.nextval, e_name);
END;

PROCEDURE cancel_room_reservation(r_id number,
                                                    g_id number,
                                                    b_id number
                                                    ) IS
BEGIN
    DELETE FROM room_reservation WHERE room_id = r_id AND guest_id = g_id AND booking_id = b_id;
END;

END;
　→「CREATE OR REPLACE PACKAGE BODY create_object IS」以下で作成された6つのプロシージャをパッケージ「create_object」にまとめて実装するSQL。
　　＊プロシージャの処理内容については、「TraceSQL3」で解析したプロシージャと同一のため割愛
